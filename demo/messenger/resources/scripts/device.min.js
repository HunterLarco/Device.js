/* Device.js 1.0.0
 * -----------------
 *
 * (c) 2015 Hunter Larco <larcolabs.com>
 * Device.js may be freely distributed under the MIT license.
 * For all details and documentation:
 * <https://github.com/HunterLarco/Device.js>
*/
!function(){var n={};!function(){function e(){for(var n=!1,e=0;e<t.length;e++){try{n=t[e]()}catch(i){continue}break}return n}n.Post=function(n,t,i,o){"string"!=typeof t&&(t=JSON.stringify(t));var r=e();r.open("POST",n,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){return 4==r.readyState?200!=r.status&&304!=r.status?void("function"==typeof o&&o(r)):void("function"==typeof i&&i(r)):void 0},r.send(t)};var t=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]}(),function(){function e(e,t,i,o){function r(n){var e=JSON.parse(n.response);"ok"!=e.stat?o(e):"function"==typeof i&&i(e.data)}function c(){"function"==typeof o&&o({stat:"fail",code:"-1",message:"Unknown Internal Error"})}n.Post(e,t,r,c)}function t(){function n(n,e){n="on"+n,"function"==typeof e&&(s[n]||(s[n]=[]),s[n].indexOf(e)>-1||s[n].push(e))}function t(n,e){n="on"+n,s[n]&&s[n].splice(s[n].indexOf(e),1)}function i(n,e){n="on"+n;var t=s[n];if(t)for(var i,o=0;i=t[o++];)i(e)}function r(){var n={__method__:"device.register"};e("/device",n,c,f)}function c(n){window.Device=new o(n.identifier,n.channel),i("register",window.Device)}function f(){console.error("Device Registration Failed: Unknown Error")}var u=this,s={};u.register=r,u.addEventListener=n,u.removeEventListener=t}function i(){function n(n,e){n="on"+n,"function"==typeof e&&(p[n]||(p[n]=[]),p[n].indexOf(e)>-1||p[n].push(e))}function t(n,e){n="on"+n,p[n]&&p[n].splice(p[n].indexOf(e),1)}function i(n,e){n="on"+n;var t=p[n];if(t)for(var i,o=0;i=t[o++];)i(e)}function o(){v=!0,i("verify",d)}function r(n,t,i){function o(){e("/device",{__method__:"device.send",method:n,data:t,target:s,source:a.identifier()},null,r)}function r(){var n=Math.pow(2,c++);console.info("API Error: Retrying in "+n+" seconds"),setTimeout(o,1e3*n)}t=t?t:{},i=i?!1:!0;var c=0;o()}function c(){r("device.connection.ping")}function f(){return s}function u(){return v}var s,a,d=this,v=!1,p={};d.send=r,d.identifier=f,d.isverified=u,d.__ping__=c,d.__verify__=o,d.addEventListener=n,d.removeEventListener=t,function(n,e){s=n,a=e}.apply(this,arguments)}function o(){function n(n,e){n="on"+n,"function"==typeof e&&(m[n]||(m[n]=[]),m[n].indexOf(e)>-1||m[n].push(e))}function e(n,e){n="on"+n,m[n]&&m[n].splice(m[n].indexOf(e),1)}function t(n,e){n="on"+n;var t=m[n];if(t)for(var i,o=0;i=t[o++];)i(e)}function o(n){t("verify",{source:y,target:n})}function r(){for(var n,e=0;n=w[e++];)n.send.apply(n,arguments)}function c(){return w}function f(n){for(var e,t=0;e=w[t++];)if(e.identifier()==n)return e;return null}function u(){return l}function s(n){{var e=JSON.parse(n.data);e.method}if("device"==e.method.split(".")[0])switch(e.method){case"device.connection.ping":v(e)}else t("message",e)}function a(){console.error("Unexpected Channel Disconnect")}function d(n,e){var t=new i(n,y);return t.addEventListener("verify",e),t.addEventListener("verify",o),w.push(t),t.__ping__(),t}function v(n){var e=f(n.source);e||(e=d(n.source)),e.isverified()||e.__verify__()}function p(){g=new goog.appengine.Channel(_),h=g.open(),h.onmessage=s,h.onclose=a}var l,g,_,h,y=this,w=[],m={};y.connect=d,y.identifier=u,y.send=r,y.devices=c,y.device=f,y.addEventListener=n,y.removeEventListener=e,function(n,e){l=n,_=e,p()}.apply(this,arguments)}window.Device=new t}()}();